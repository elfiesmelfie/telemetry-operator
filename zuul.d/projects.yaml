---
# copied from neutron-operator: https://github.com/openstack-k8s-operators/neutron-operator/blob/main/zuul.d/jobs.yaml
# Something similar exists in nova-operator, which uses podified-multinode-edpm-deployment-crc-3comp as a parent: https://github.com/openstack-k8s-operators/nova-operator/blob/main/.zuul.yaml#L116
- job:
    name: telemetry-operator-tempest-multinode
    parent: podified-multinode-edpm-deployment-crc
    dependencies: ["openstack-k8s-operators-content-provider"]
    vars:
      test_fw: test_operator
      # workaround(gabbi_version)
      # Using master for now because the sg_core telemetry tests are not compatible with antelope due to an incompatible version of gabbi
      # The workaround in the telemetry-tempest-plugin patch needs to be incorporated into TCIB
      cifmw_test_operator_tempest_namespace: podified-master-centos9
      cifmw_test_operator_tempest_container: openstack-tempest-all
      cifmw_test_operator_tempest_image_tag: 'current-podified'
      # TODO: Remove the externalPlugin before merging since we want the tests running from the antelope container.
      # This requires a release of telemetry-tempest-plugin that gets included in packages installed int he openstack-tempest-all containers built by TCIB.
      # Once that is being built, the external_plugin won't be needed
      # TODO: merge the change that allows external_plugin to be passed to the CR: https://github.com/openstack-k8s-operators/ci-framework/pull/1065
      cifmw_test_operator_tempest_external_plugin:
        # workaround(telemetry_tempest_plugin_release)
        # NOTE: Until the telemetry-tempest-plugin repo is tagged and the new version is used in the tempest image, we need to manually install it as an external plugin to use the autoscaling tests.
        # Once this job runs all the autoscaling tests and passes using telemetry-tempest-plugin/master, the release can be tagged since it works against OSP18 deployments.
        # - repository: "https://opendev.org/openstack/telemetry-tempest-plugin.git"
        #   changeRepository: "https://review.opendev.org/openstack/telemetry-tempest-plugin"
        #   changeRefspec: "master"
        # workaround(gabbi_version)
        # NOTE: This review is being used because tempest/antelope container has an incompatible version of gabbi, and it was easier to verify this fix in this patch rather than in TCIB.
        # TODO: Update the version of gabbi used in TCIB instead of in telemetry-tempest-plugin.
        # Once that update is made, this patch is not needed, and the podified-antelope-centos9 namespace can be used again to select the antelope version of the tempest image.
        - repository: "https://opendev.org/openstack/telemetry-tempest-plugin.git"
          changeRepository: "https://review.opendev.org/openstack/telemetry-tempest-plugin"
          changeRefspec: "refs/changes/32/907432/1"
      # This value is used to populate the `tempestconfRun` parameter of the Tempest CR: https://openstack-k8s-operators.github.io/test-operator/crds.html#tempest-custom-resource
      # https://github.com/openstack-k8s-operators/ci-framework/blob/main/roles/test_operator/defaults/main.yml
      cifmw_tempest_tempestconf_config:
        debug: true
        # NOTE(gibi): This is a WA to force the publicURL as otherwise
        # tempest gets configured with adminURL and that causes test
        # instability.
        overrides: |
            validation.run_validation true
            identity.v3_endpoint_type public
            service_available.ceilometer true
            service_available.sg_core true
            service_available.aodh true
            telemetry.sg_core_service_url "ceilometer.openstack.svc.cluster.local:3000"
      cifmw_test_operator_tempest_include_list: |
        telemetry_tempest_plugin.scenario
        telemetry_tempest_plugin.aodh
      cifmw_test_operator_tempest_exclude_list: ''
      cifmw_install_yamls_vars:
        TELEMETRY: config/samples/telemetry_v1beta1_autoscaling.yaml

- project:
    name: openstack-k8s-operators/telemetry-operator
    #  templates:
    #    - podified-multinode-edpm-pipeline
    github-check:
      jobs:
        - openstack-k8s-operators-content-provider
          # Later, it might be prudent to run the podified-multinode-edpm-deployment-crc job as a provider, and say it provides a "deployed-openstack", so the tempest job can use it as a dependency and not redeploy everything.
        - telemetry-operator-tempest-multinode
